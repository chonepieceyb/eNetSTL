# eNetSTL

**其他语言版本: [English](README.md), [中文](README_zh.md).**

eNetSTL 源码仓库。

## 1. 目录结构

```
├── src                     # 网络功能
│   ├── bpf_kern            # eBPF 程序
│   ├── c                   # 用户态 C 程序
│   ├── python              # Python 实验脚本程序
│   └── LKM                 # 内核模块
│        ├── bpf_ptr_structure_lib    # 指针类基础库
│        ├── eNetSTL                  # SIMD 并行哈希基础库
│        └── expN           # 每个实验所用到的内核模块
├── build                   # eBPF网络功能构建目录
└── log                     # 实验数据目录
```

## 2. 构建与使用

### 下载资源
**只有自行构建Docker镜像或编译内核时需要**
1. 下载 GITHUB release 中的 `resources.tar.gz`
2. 解压到`Docker/`下，解压后的目录应为`Docker/resources`

### 安装内核
由于实验的baseline修改了内核代码，并且需要rust支持，因此需要安装新的内核。内核的镜像位于 GITHUB release 中 `resources.tar.gz`。

或自行编译内核，patch文件位于`patches`下,下载[Linux 6.6](https://github.com/torvalds/linux/releases/tag/v6.6)，打上patch后并在编译选项中[开启rust支持](https://docs.kernel.org/rust/index.html)。

自行编译后，需要将编译产物`vmlinux`拷贝到`Docker/resources/`

### 构建Docker镜像
可以使用已构建好的镜像（需要使用提供好的内核镜像）`docker pull chonepieceyb/enetstl:v0.1`，或者用DockerFile自行构建镜像：

1. 切换到已编译好的内核
2. 构建Docker镜像
   ```shell
   cd Docker
   ./build.sh
   ```


### 运行Docker
在拉取或构建好Docker镜像之后，运行Docker：
   ```shell
   cd Docker
   ./run.sh
   ```

### 构建并加载内核模块

**后续操作在Docker容器内目录`/root/eNetSTL`执行**

以 `eNetSTL`模块为例，

1. 进入相应模块目录，构建内核模块：

   ```bash
   cd src/LKM/eNetSTL
   make LLVM=1
   ```

2. 加载内核模块：

   ```bash
   sudo insmod eNetSTL.ko
   ```

### 构建并加载网络功能

1. 更改`src/c/config.h`文件中网络功能加载时绑定的网卡（后续实验中的收包网卡）：

   ```c
   #define XDP_IF "<网卡名>"
   ```

2. 构建网络功能 eBPF 与用户态程序：

   ```bash
   mkdir -p build
   cd build
   # 如果需要进行延迟测试实验，需要设置DUSE_LATENCY_EXP参数为on
   cmake -DLOG_LEVEL=0 -DUSE_LATENCY_EXP=off ..
   make clean && make -j$(nproc)
   ```

3. 构建完成后，用户态控制程序（通过 BPF skeleton 已包含 BPF 程序）在 `bin/` 目录下，可以直接执行：

   ```bash
   sudo ./bin/empty_base_user
   ```


## 3. 实验环境搭建

实验需要使用两台物理机分别用作发包设备和被测试设备（DUT）。其中发包设备需要具备支持DPDK的网卡。

### 发包设备

发包设备需要提前安装好[DPDK 22.11.6](https://core.dpdk.org/download/)和[Trex v3.03](https://trex-tgn.cisco.com/trex/release/)

DPDK的配置和Trex的安装使用可以参照Trex提供的[教程](https://trex-tgn.cisco.com/trex/doc/trex_manual.html#_download_and_installation)

完成DPDK巨页内存分配，PMD驱动绑定后，完善Trex的网卡配置

Trex的网卡配置文件默认位置为`/etc/trex_cfg.yaml`，示例配置如下

```yaml
### Config file generated by dpdk_setup_ports.py ###

- version: 2
  interfaces: ['0000:08:00.0', '0000:08:00.1'] # 发包网卡的PCIE地址
  port_info:
    - src_mac:  6c:b3:11:21:b6:60 # 发包网卡 port0 MAC
      dest_mac: 6c:b3:11:21:b6:58 # DUT收包网卡 MAC 
    - src_mac:  6c:b3:11:21:b6:62 
      dest_mac: 6c:b3:11:21:b6:5a

  platform:
      master_thread_id: 0
      latency_thread_id: 6 # 延迟测量线程所在CPU核
      dual_if:
        - socket: 0
          threads: [1,2,3,4,5] # 发包线程所在CPU核（根据实际情况调整）
```

TRex配置妥当后，在Trex安装目录执行下面命令来启动Trex服务端

```shell
sudo ./t-rex-64 -i -c 5
```

至此发包设备配置完毕，实验过程中需要确保Trex服务端的持续运行

### DUT

#### 前置工作

1. 需要在该设备上完成所有`内核模块`和`bpf网络功能`的编译

2. 修改`src/python/exp_config.py`文件中`interface_name`变量为当前设备的收包网卡

3. 修改`src/python/exp_config.py`文件中`TREX_SERVER`变量为发包设备的IP地址

4. 修改`src/python/exp_config.py`文件中`LAT_TEST_PORT`变量为发包设备发包网卡的port编号

5. 通过配置RSS，修改收包网卡队列数为1

#### 实验脚本运行

在`src/python`目录下执行下面命令来进行吞吐率实验

```shell
sudo python exp.py -c 5 pps
```


在修改cmake编译`-DUSE_LATENCY_EXP=on`参数重新编译后，执行下面命令来执行延迟实验
```shell
sudo python exp.py -c 5 lat_no
```

该脚本会自动化完成发包设备的打流，网络功能和内核模块的加载，实验数据的记录，启动后只需等待其运行结束即可。

等待所有实验运行完毕后，最终所有的实验数据会记录在`log`目录下

